# 对象创建

## 给对象分配可用空间

- 指针碰撞：假设内存规整，有个指针，一边是使用的内存，一边是空闲内存，分配相当于指针移动。
- 空闲列表：假设内存不规整，需要维护列表，记录可以用的内存，分配时候从列表找一个足够大的分给对象实例，然后更新列表。

以上选择哪一种由 `Java` 堆是不是规整决定，是否规整由垃圾回收器是不是有压缩整理功能决定。
`Compact` 算法：`Serial`，`ParNew`，指针碰撞
空闲列表：`CMS`（基于 `Mark-Sweep` 标记清除）

## 指针修改是否频繁

修改指针的指向，并发的时候不是线程安全的，可能出现给 A 分配内存，指针还没有改，B 又使用了原来的指针分配内存，有两种解决方案：

- 分配内存时候同步，虚拟机用了 `CAS`+失败重试，保证更新原子性
- 内存分配动作，放到不同的空间，每一个线程预分配一个内存，作为本地线程分配缓冲（TLAB）。先在自己的 TLAB 上分，TLAB 用完再分配新的，这时候需要同步锁定。

需不需要用 TLAB，可以通过-XX：+/-UseTLAB 参数设置
分配完内存的时候，需要初始化零值（除了对象头），若使用 TLAB，也可以提前在 TLAB 分配的时候初始化零值。

初始化零值后，需要设置对象，主要是对象头的设置。

- 对象是哪一个类的实例
- 如如何查找类的元数据信息
- 对象的哈希码
- 对象 `GC` 分代年龄

以上完成，一个对象产生在虚拟机里面了。但是对 java 的用户来说，还是不可用的，对象创建在表面上刚刚开始。执行 new 指令之后，执行 init()方法，按照程序猿的意愿赋值，可以用的对象产生了。

# 对象的内存布局

对象在内存里面包括三部分：

- 对象头：`header`
  - `Mark Word` :存储对象运行时的数据（32 位虚拟机是 32Bits，64 位虚拟机是 64Bits）：
    - 哈希码（HashCode）
    - GC 分代年龄
    - 锁状态标志
    - 线程持有的锁
    - 偏向线程 ID
    - 偏向时间戳
- 实例数据： `Instance Data`
- 对齐填充： `Padding`
<html>
<table>
    <tr>
        <td rowspan="2">锁状态</td>
        <td colspan="2">25 bit</td>
        <td rowspan="2">4 bit</td>
        <td>1 bit</td>
        <td>2 bit</td>
    </tr>
    <tr>
        <td>23 bit</td>
        <td>2 bit</td>
        <td>是否偏向锁</td>
        <td>锁标志位</td>
    </tr>
    <tr>
        <td>无锁</td>
        <td colspan="2">对象的HashCode</td>
        <td>分代年龄</td>
        <td>0</td>
        <td>01</td>
    </tr>
    <tr>
        <td>偏向锁</td>
        <td>线程ID</td>
        <td>Epoch</td>
        <td>分代年龄</td>
        <td>1</td>
        <td>01</td>
    </tr>
    <tr>
        <td>轻量级锁</td>
        <td colspan="4">指向栈中锁记录的指针</td>
        <td>00</td>
    </tr>
        <tr>
        <td>重量级锁</td>
        <td colspan="4">指向重量级锁记录的指针</td>
        <td>10</td>
    </tr>
     </tr>
        <tr>
        <td>GC标记</td>
        <td colspan="4">空</td>
        <td>11</td>
    </tr>   
</table>
</html>

Mark Word :
运行时的数据很多，但是 Mark Word 时不固定的数据结构，属于与对象本身定义的数据无关的额外存储成本，设计越小越好。


![](https://markdownpicture.oss-cn-qingdao.aliyuncs.com/blog/%E5%85%AC%E4%BC%97%E5%8F%B7%E5%85%B3%E6%B3%A8.png)
